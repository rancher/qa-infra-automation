---
- name: Display Cluster and Rancher Information
  hosts: bastion
  gather_facts: true

  vars:
    rancher_private_hostname: "{{ rancher_hostname | default(internal_lb_hostname) }}"
    rancher_public_hostname: "{{ public_hostname | default(external_lb_hostname) | default('') }}"
    rancher_namespace: "cattle-system"

  tasks:
    - name: Check if kubectl is configured
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/.kube/config"
      register: kubectl_config

    - name: Fail if kubectl is not configured
      ansible.builtin.fail:
        msg: "kubectl is not configured on the bastion node."
      when: not kubectl_config.stat.exists

    # Cluster Information
    - name: Get cluster nodes
      ansible.builtin.command: kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false
      failed_when: false
      environment:
        KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

    - name: Get cluster version
      ansible.builtin.command: kubectl version -o yaml
      register: cluster_version_raw
      changed_when: false
      failed_when: false
      environment:
        KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

    - name: Parse cluster version
      ansible.builtin.set_fact:
        cluster_version_info: "{{ cluster_version_raw.stdout | from_yaml }}"
      when: cluster_version_raw.rc == 0 and cluster_version_raw.stdout | length > 0

    - name: Format cluster version
      ansible.builtin.set_fact:
        cluster_version: "Server: {{ cluster_version_info.serverVersion.gitVersion | default('Unknown') }} | Client: {{ cluster_version_info.clientVersion.gitVersion | default('Unknown') }}"
      when: cluster_version_info is defined

    # Rancher Information
    - name: Check if Rancher is deployed
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: rancher
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
      register: rancher_deployment
      failed_when: false

    - name: Get Rancher pods
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ rancher_namespace }}"
        label_selectors:
          - app=rancher
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
      register: rancher_pods
      when: rancher_deployment.resources | default([]) | length > 0
      failed_when: false

    - name: Get Rancher service
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: rancher
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
      register: rancher_service
      when: rancher_deployment.resources | default([]) | length > 0
      failed_when: false

    - name: Get Rancher ingress
      kubernetes.core.k8s_info:
        api_version: networking.k8s.io/v1
        kind: Ingress
        name: rancher
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
      register: rancher_ingress
      when: rancher_deployment.resources | default([]) | length > 0
      failed_when: false

    - name: Check Rancher API health
      ansible.builtin.uri:
        url: "https://{{ rancher_private_hostname }}/ping"
        method: GET
        validate_certs: false
        status_code: 200
        timeout: 10
      register: rancher_api_check
      failed_when: false
      when: rancher_deployment.resources | default([]) | length > 0

    # Check for API tokens (secrets with type bootstrap or token)
    - name: Get Rancher token secrets
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
      register: rancher_secrets
      when: rancher_deployment.resources | default([]) | length > 0
      failed_when: false

    - name: Filter token secrets
      ansible.builtin.set_fact:
        token_secrets: "{{ rancher_secrets.resources | default([]) | selectattr('metadata.name', 'match', '.*token.*') | list }}"
      when: rancher_secrets is defined and rancher_secrets.resources is defined

    # Read saved summary if exists
    - name: Check for deployment summary file
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/rancher-deployment-summary.txt"
      register: summary_file

    - name: Read bootstrap password from summary
      ansible.builtin.slurp:
        src: "/home/{{ ansible_user }}/rancher-deployment-summary.txt"
      register: summary_content
      when: summary_file.stat.exists

    - name: Extract bootstrap password
      ansible.builtin.set_fact:
        saved_bootstrap_password: "{{ (summary_content.content | b64decode | regex_search('Bootstrap Password: (.+)', '\\1'))[0] | default('Not found in summary') }}"
      when: summary_file.stat.exists and summary_content is defined

    # Display all information
    - name: Display cluster and Rancher information
      ansible.builtin.debug:
        msg: |
          ╔════════════════════════════════════════════════════════════════════════════╗
          ║                         CLUSTER INFORMATION                                ║
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  Kubernetes Version: {{ cluster_version | default('Unknown') }}
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  Nodes:
          {{ cluster_nodes.stdout | default('Unable to get nodes') | indent(3, false) }}
          ╠════════════════════════════════════════════════════════════════════════════╣
          {% if rancher_deployment.resources | default([]) | length > 0 %}
          ║                         RANCHER INFORMATION                                ║
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  Deployment Status:  {{ 'READY' if (rancher_deployment.resources[0].status.readyReplicas | default(0)) > 0 else 'NOT READY' }}
          ║  Replicas:           {{ rancher_deployment.resources[0].status.readyReplicas | default(0) }}/{{ rancher_deployment.resources[0].spec.replicas | default(0) }}
          ║  API Status:         {{ 'HEALTHY' if (rancher_api_check.status | default(0)) == 200 else 'UNREACHABLE' }}
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  ACCESS URLS                                                               ║
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  Public URL:         https://{{ rancher_public_hostname }}
          ║  Internal URL:       https://{{ rancher_private_hostname }}
          ║  Namespace:          {{ rancher_namespace }}
          {% if rancher_ingress.resources | default([]) | length > 0 %}
          ║  Ingress Hosts:      {{ rancher_ingress.resources[0].spec.rules | map(attribute='host') | list | join(', ') }}
          {% endif %}
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  CREDENTIALS                                                               ║
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  Bootstrap Password: {{ saved_bootstrap_password | default(rancher_bootstrap_password | default('Check rancher-deployment-summary.txt')) }}
          {% if token_secrets | default([]) | length > 0 %}
          ║  Token Secrets:      {{ token_secrets | length }} found
          {% for secret in token_secrets[:5] %}
          ║    - {{ secret.metadata.name }}
          {% endfor %}
          {% if token_secrets | length > 5 %}
          ║    ... and {{ token_secrets | length - 5 }} more
          {% endif %}
          {% else %}
          ║  Token Secrets:      None found
          {% endif %}
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  PODS STATUS                                                               ║
          ╠════════════════════════════════════════════════════════════════════════════╣
          {% for pod in rancher_pods.resources | default([]) %}
          ║    {{ pod.metadata.name }}: {{ pod.status.phase }}
          {% endfor %}
          {% else %}
          ║                         RANCHER NOT DEPLOYED                               ║
          ╠════════════════════════════════════════════════════════════════════════════╣
          ║  Rancher is not deployed on this cluster.                                  ║
          ║  Run 'make rancher' to deploy Rancher.                                     ║
          {% endif %}
          ╚════════════════════════════════════════════════════════════════════════════╝

          Summary file: /home/{{ ansible_user }}/rancher-deployment-summary.txt
