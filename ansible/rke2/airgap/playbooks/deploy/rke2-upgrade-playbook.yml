---
- name: RKE2 Airgap Upgrade - Pre-upgrade Validation
  hosts: "{{ target_group }}"
  become: true
  gather_facts: true
  vars_files:
    - ../group_vars/all.yml
  vars:
    target_group: "{{ target | default('rancher') }}"

  pre_tasks:
    - name: Get latest RKE2 version
      ansible.builtin.uri:
        url: https://update.rke2.io/v1-release/channels/stable
        follow_redirects: none
        return_content: yes
        status_code: 302
      register: raw_version_response
      when: rke2_version is not defined

    - name: Set rke2_version fact for all hosts
      ansible.builtin.set_fact:
        rke2_version: "{{ raw_version_response.content | regex_search('tag/([^/\" >]+)', '\\1') | first }}"
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"
      when: raw_version_response is defined

    - name: Validate required variables for upgrade
      ansible.builtin.assert:
        that:
          - rke2_version is defined
          - rke2_version is match('^v[0-9]+\.[0-9]+\.[0-9]+')
          - groups['bastion'] is defined
          - groups['bastion'] | length > 0
          - groups[target_group] is defined
          - groups[target_group] | length > 0
          - ssh_private_key_file is defined
          - ansible_user is defined
        fail_msg: |
          Required variable validation failed. Please check:
          - rke2_version is defined and matches format 'vX.Y.Z' (found: {{ rke2_version | default('undefined') }})
          - bastion group has at least one host (found: {{ groups['bastion'] | default([]) | length }})
          - {{ target_group }} group has at least one host (found: {{ groups[target_group] | default([]) | length }})
          - ssh_private_key_file is defined (found: {{ ssh_private_key_file | default('undefined') }})
          - ansible_user is defined (found: {{ ansible_user | default('undefined') }})
        success_msg: "All required variables are valid for upgrade"

  tasks:
    - name: Check current RKE2 installation
      ansible.builtin.shell: |
        if [ -f /usr/local/bin/rke2 ]; then
          echo "installed"
        else
          echo "not-installed"
        fi
      register: rke2_installed
      changed_when: false

    - name: Fail if RKE2 is not installed
      ansible.builtin.fail:
        msg: "RKE2 is not installed on {{ inventory_hostname }}. Use the installation playbook first."
      when: rke2_installed.stdout == "not-installed"

    - name: Get current RKE2 version
      ansible.builtin.shell: |
        set -o pipefail
        /usr/local/bin/rke2 --version | head -1 | awk '{print $3}'
      args:
        executable: /bin/bash
      register: current_version
      changed_when: false

    - name: Check RKE2 service status
      ansible.builtin.systemd:
        name: "{{ 'rke2-server' if inventory_hostname == groups[target_group][0] else 'rke2-agent' }}"
      register: service_status

    - name: Display pre-upgrade status
      ansible.builtin.debug:
        msg: |
          Pre-upgrade Status for {{ inventory_hostname }}:
          - Current RKE2 Version: {{ current_version.stdout }}
          - Target RKE2 Version: {{ rke2_version }}
          - Service Status: {{ service_status.status.ActiveState }}
          - Upgrade Required: {{ current_version.stdout != rke2_version }}

    - name: Check disk space
      ansible.builtin.shell: |
        set -o pipefail
        df -h /var/lib/rancher | tail -1 | awk '{print $4}'
      args:
        executable: /bin/bash
      register: disk_space
      changed_when: false

    - name: Warn about disk space
      ansible.builtin.debug:
        msg: "WARNING: Low disk space available: {{ disk_space.stdout }}"
      when: disk_space.stdout | regex_replace('[^0-9]', '') | int < 5

- name: RKE2 Airgap Upgrade - Download New Version
  hosts: bastion
  become: true
  gather_facts: true
  vars:
    target_group: "{{ target | default('rancher') }}"
  vars_files:
    - ../group_vars/all.yml
  tasks:
    - name: Check if upgrade is needed
      ansible.builtin.set_fact:
        upgrade_needed: "{{ hostvars[groups[target_group][0]]['current_version']['stdout'] != rke2_version }}"

    - name: Download and prepare new RKE2 tarball bundle
      ansible.builtin.include_role:
        name: rke2_tarball
      when: upgrade_needed

    - name: Skip download if no upgrade needed
      ansible.builtin.debug:
        msg: "All nodes are already at version {{ rke2_version }}. Skipping download."
      when: not upgrade_needed

- name: RKE2 Airgap Upgrade - Upgrade Server Node
  hosts: "{{ target_group }}[0]" # First server node only
  become: true
  gather_facts: true
  serial: 1
  vars_files:
    - ../group_vars/all.yml
  vars:
    target_group: "{{ target | default('rancher') }}"
  tasks:
    - name: Check if upgrade is needed for server
      ansible.builtin.set_fact:
        server_upgrade_needed: "{{ current_version.stdout != rke2_version }}"

    - name: Upgrade RKE2 server
      ansible.builtin.include_role:
        name: rke2_upgrade
      when: server_upgrade_needed

    - name: Skip server upgrade
      ansible.builtin.debug:
        msg: "Server is already at version {{ rke2_version }}. Skipping upgrade."
      when: not server_upgrade_needed

    - name: Verify server is operational after upgrade
      when: server_upgrade_needed
      block:
        - name: Wait for RKE2 server to be ready
          ansible.builtin.wait_for:
            path: /var/lib/rancher/rke2/server/node-token
            timeout: 300

        - name: Check server service status
          ansible.builtin.systemd:
            name: rke2-server
          register: server_status

        - name: Verify kubectl functionality
          ansible.builtin.shell: |
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            /var/lib/rancher/rke2/bin/kubectl get nodes
          register: kubectl_test
          failed_when: kubectl_test.rc != 0
          changed_when: false
          become: true

        - name: Display server upgrade verification
          ansible.builtin.debug:
            msg: |
              Server Upgrade Verification:
              - Service Status: {{ server_status.status.ActiveState }}
              - kubectl Test: {{ 'PASSED' if kubectl_test.rc == 0 else 'FAILED' }}
              - Cluster Nodes: {{ kubectl_test.stdout_lines | length - 1 }} nodes visible

- name: RKE2 Airgap Upgrade - Upgrade Agent Nodes
  hosts: "target_group[1:]" # All nodes except the first (server)
  become: true
  gather_facts: true
  serial: 2 # Upgrade 2 agents at a time for faster upgrades
  vars:
    target_group: "{{ target | default('rancher') }}"
  vars_files:
    - ../group_vars/all.yml
  tasks:
    - name: Check if upgrade is needed for agent
      ansible.builtin.set_fact:
        agent_upgrade_needed: "{{ current_version.stdout != rke2_version }}"

    - name: Upgrade RKE2 agent
      ansible.builtin.include_role:
        name: rke2_upgrade
      when: agent_upgrade_needed

    - name: Skip agent upgrade
      ansible.builtin.debug:
        msg: "Agent {{ inventory_hostname }} is already at version {{ rke2_version }}. Skipping upgrade."
      when: not agent_upgrade_needed

    - name: Verify agent is operational after upgrade
      when: agent_upgrade_needed
      block:
        - name: Check agent service status
          ansible.builtin.systemd:
            name: rke2-agent
          register: agent_status

        - name: Wait for upgraded agent to rejoin cluster
          ansible.builtin.shell: |
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            /var/lib/rancher/rke2/bin/kubectl get node {{ inventory_hostname }} --no-headers | grep -q " Ready"
          delegate_to: "{{ groups[target_group][0] }}"
          register: agent_rejoin_check
          until: agent_rejoin_check.rc == 0
          retries: 18
          delay: 10
          become: true
          changed_when: false

        - name: Verify agent joined cluster
          ansible.builtin.shell: |
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            /var/lib/rancher/rke2/bin/kubectl get nodes {{ inventory_hostname }} -o wide
          register: node_status
          delegate_to: "{{ groups[target_group][0] }}"
          failed_when: false
          changed_when: false
          become: true

        - name: Display agent upgrade verification
          ansible.builtin.debug:
            msg: |
              Agent Upgrade Verification for {{ inventory_hostname }}:
              - Service Status: {{ agent_status.status.ActiveState }}
              - Node Status: {{ 'JOINED' if node_status.rc == 0 else 'NOT JOINED' }}
              {% if node_status.rc == 0 %}
              - Node Details: {{ node_status.stdout }}
              {% endif %}

- name: RKE2 Airgap Upgrade - Post-upgrade Verification
  hosts: target_group[0] # Run verification from server node
  gather_facts: false
  vars:
    target_group: "{{ target | default('rancher') }}"
  vars_files:
    - ../group_vars/all.yml
  tasks:
    - name: Final cluster verification
      block:
        - name: Get all cluster nodes
          ansible.builtin.shell: |
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            /var/lib/rancher/rke2/bin/kubectl get nodes -o wide
          register: final_cluster_status
          changed_when: false
          become: true

        - name: Get cluster version info
          ansible.builtin.shell: |
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            /var/lib/rancher/rke2/bin/kubectl version --output=yaml
          register: cluster_version
          changed_when: false
          become: true
          failed_when: false

        - name: Get system pods status
          ansible.builtin.shell: |
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            /var/lib/rancher/rke2/bin/kubectl get pods -n kube-system
          register: system_pods
          changed_when: false
          become: true

        - name: Display final upgrade results
          ansible.builtin.debug:
            msg: |
              RKE2 Cluster Upgrade Complete!

              [INFO] Target Version: {{ rke2_version }}

              [INFO] Cluster Status:
              {{ final_cluster_status.stdout }}

              [INFO] Kubernetes Version:
              {{ cluster_version.stdout }}

              [INFO] System Pods Status:
              {{ system_pods.stdout }}

              [INFO] Upgrade Summary:
              - Server nodes upgraded: {{ groups[target_group] | length >= 1 }}
              - Agent nodes upgraded: {{ (groups[target_group] | length - 1) if groups[target_group] | length > 1 else 0 }}
              - Total nodes in cluster: {{ final_cluster_status.stdout_lines | length - 1 }}

        - name: Wait for all nodes to be Ready after upgrade
          ansible.builtin.shell: |
            set -o pipefail
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            NOT_READY=$(/var/lib/rancher/rke2/bin/kubectl get nodes --no-headers | grep -v " Ready" | wc -l)
            TOTAL=$(/var/lib/rancher/rke2/bin/kubectl get nodes --no-headers | wc -l)
            if [ "$NOT_READY" -eq 0 ]; then
              echo "All $TOTAL nodes are Ready"
              exit 0
            else
              echo "Waiting: $NOT_READY of $TOTAL nodes not Ready"
              exit 1
            fi
          args:
            executable: /bin/bash
          register: nodes_ready_check
          until: nodes_ready_check.rc == 0
          retries: 30
          delay: 10
          changed_when: false
          become: true

        - name: Display nodes ready status
          ansible.builtin.debug:
            msg: "[OK] {{ nodes_ready_check.stdout }}"
          when: nodes_ready_check.rc == 0

        - name: Wait for critical system pods to be Running after upgrade
          ansible.builtin.shell: |
            set -o pipefail
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            NOT_RUNNING=$(/var/lib/rancher/rke2/bin/kubectl get pods -n kube-system --no-headers | grep -v Running | grep -v Completed | wc -l)
            if [ "$NOT_RUNNING" -eq 0 ]; then
              echo "All system pods are Running"
              /var/lib/rancher/rke2/bin/kubectl get pods -n kube-system
              exit 0
            else
              echo "Waiting for $NOT_RUNNING pods to be Running..."
              /var/lib/rancher/rke2/bin/kubectl get pods -n kube-system | grep -v Running | grep -v Completed
              exit 1
            fi
          args:
            executable: /bin/bash
          register: system_pods_check
          until: system_pods_check.rc == 0
          retries: 30
          delay: 10
          changed_when: false
          become: true

        - name: Display system pods status
          ansible.builtin.debug:
            msg: |
              System Pods Status:
              {{ system_pods_check.stdout }}
          when: system_pods_check is defined

- name: RKE2 Airgap Upgrade - Update kubectl on Bastion
  hosts: bastion
  become: true
  gather_facts: true
  vars_files:
    - ../group_vars/all.yml
  tasks:
    - name: Update kubectl to match cluster version
      block:
        - name: Get Kubernetes version from cluster
          ansible.builtin.shell: |
            set -o pipefail
            export KUBECONFIG=/root/.kube/config
            /var/lib/rancher/rke2/bin/kubectl version --output=json | jq -r '.serverVersion.gitVersion'
          args:
            executable: /bin/bash
          register: k8s_version
          failed_when: false
          changed_when: false
          become: true

        - name: Extract Kubernetes version from RKE2 version
          ansible.builtin.set_fact:
            expected_k8s_version: "{{ rke2_version | regex_replace('^v([0-9]+\\.[0-9]+\\.[0-9]+).*', 'v\\1') }}"

        - name: Download matching kubectl version
          ansible.builtin.get_url:
            url: "https://dl.k8s.io/release/{{ expected_k8s_version }}/bin/linux/amd64/kubectl"
            dest: /usr/local/bin/kubectl
            mode: "0755"
            owner: root
            group: root
            backup: true
          register: kubectl_update
          notify: Verify kubectl update

        - name: Display kubectl update status
          ansible.builtin.debug:
            msg: |
              kubectl Update Status:
              - Expected Kubernetes Version: {{ expected_k8s_version }}
              - Cluster Kubernetes Version: {{ k8s_version.stdout | default('Unable to determine from cluster') }}
              - kubectl Updated: {{ kubectl_update is changed }}
              {% if kubectl_update is changed %}
              - New kubectl Version: {{ kubectl_version_check.stdout }}
              {% endif %}

      rescue:
        - name: Kubectl update failed
          ansible.builtin.debug:
            msg: "kubectl update failed. Manual update may be required."

    - name: Test kubectl connectivity after upgrade
      ansible.builtin.command: kubectl get nodes -o wide
      # Using command instead of shell because we need to set environment variables
      environment:
        KUBECONFIG: /root/.kube/config
      register: final_kubectl_test
      failed_when: false
      changed_when: false

    - name: Display final connectivity test
      ansible.builtin.debug:
        msg: |
          Final kubectl Connectivity Test:
          {% if final_kubectl_test.rc == 0 %}
          [SUCCESS] Cluster accessible from bastion:
          {{ final_kubectl_test.stdout }}
          {% else %}
          [FAILED] Error connecting to cluster:
          {{ final_kubectl_test.stderr }}
          {% endif %}
