---
- name: Check RKE2 Node Roles and Service Status
  hosts: airgap_nodes
  become: true
  gather_facts: true
  vars:
    target_group: "{{ target | default('rancher') }}"

  tasks:
    - name: Check which RKE2 service is installed
      ansible.builtin.stat:
        path: "{{ item }}"
      register: service_check
      loop:
        - /usr/local/lib/systemd/system/rke2-server.service
        - /usr/local/lib/systemd/system/rke2-agent.service

    - name: Display service file status
      ansible.builtin.debug:
        msg: |
          Node: {{ inventory_hostname }}
          Server service exists: {{ service_check.results[0].stat.exists }}
          Agent service exists: {{ service_check.results[1].stat.exists }}

    - name: Check RKE2 server service status
      ansible.builtin.systemd:
        name: rke2-server
      register: server_status
      failed_when: false
      when: service_check.results[0].stat.exists

    - name: Check RKE2 agent service status
      ansible.builtin.systemd:
        name: rke2-agent
      register: agent_status
      failed_when: false
      when: service_check.results[1].stat.exists

    - name: Display service status
      ansible.builtin.debug:
        msg: |
          Node: {{ inventory_hostname }}
          Server service state: {{ server_status.status.ActiveState | default('not checked') if service_check.results[0].stat.exists else 'service file not found' }}
          Agent service state: {{ agent_status.status.ActiveState | default('not checked') if service_check.results[1].stat.exists else 'service file not found' }}
          Expected role: {{ 'server' if inventory_hostname == groups[target_group][0] else 'agent' }}

    - name: Get node roles from kubectl (on server only)
      ansible.builtin.shell: |
        export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
        /var/lib/rancher/rke2/bin/kubectl get nodes -o wide
      register: node_roles
      failed_when: false
      changed_when: false
      when: inventory_hostname == groups[target_group][0]

    - name: Display cluster node information
      ansible.builtin.debug:
        msg: |
          Current cluster nodes:
          {{ node_roles.stdout }}
      when:
        - inventory_hostname == groups[target_group][0]
        - node_roles.rc == 0

    - name: Summary
      ansible.builtin.debug:
        msg: |
          =================================================================
          Node: {{ inventory_hostname }}
          Position in airgap_nodes: {{ groups[target_group].index(inventory_hostname) }}
          First node in group: {{ groups[target_group][0] }}
          Should be: {{ 'SERVER' if inventory_hostname == groups[target_group][0] else 'AGENT' }}
          Actually running: {{
            'SERVER' if (service_check.results[0].stat.exists and server_status.status.ActiveState | default('') == 'active')
            else ('AGENT' if (service_check.results[1].stat.exists and agent_status.status.ActiveState | default('') == 'active')
            else 'NEITHER')
          }}
          =================================================================
