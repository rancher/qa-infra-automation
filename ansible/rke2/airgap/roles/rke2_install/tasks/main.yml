---
- name: Create RKE2 config directory
  ansible.builtin.file:
    path: /etc/rancher/rke2
    state: directory
    mode: '0755'
  become: true

- name: Configure RKE2 server
  ansible.builtin.template:
    src: config.yaml.j2
    dest: /etc/rancher/rke2/config.yaml
    mode: '0644'
  become: true
  when: inventory_hostname == groups[target_group][0]

- name: Create RKE2 artifact directory
  ansible.builtin.file:
    path: /tmp/rke2-artifacts
    state: directory
    mode: '0755'
  become: true

- name: Synchronize RKE2 bundle from bastion
  block:
    - name: Check bundle on bastion
      delegate_to: "{{ groups['bastion'][0] }}"
      vars:
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
      block:
        - name: Get bundle size
          ansible.builtin.stat:
            path: /opt/rke2-files/rke2-bundle.tar.gz
          register: bastion_bundle

        - name: Calculate bundle checksum
          ansible.builtin.command: sha256sum /opt/rke2-files/rke2-bundle.tar.gz
          register: bastion_checksum
          changed_when: false

    - name: Ensure local temp directory exists with proper permissions
      ansible.builtin.file:
        path: /tmp
        state: directory
        mode: '1777'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: true

    - name: Ensure bundle destination has proper permissions
      ansible.builtin.file:
        path: /tmp/rke2-bundle.tar.gz
        state: touch
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: true

    - name: Copy bundle from bastion via controller
      block:
        - name: Fetch bundle from bastion to controller
          ansible.builtin.fetch:
            src: /opt/rke2-files/rke2-bundle.tar.gz
            dest: /tmp/ansible-rke2-bundle.tar.gz
            flat: true
          delegate_to: "{{ groups['bastion'][0] }}"
          become: false
          run_once: true

        - name: Copy bundle from controller to airgap node
          ansible.builtin.copy:
            src: /tmp/ansible-rke2-bundle.tar.gz
            dest: /tmp/rke2-bundle.tar.gz
            mode: '0644'
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
          become: true
          register: copy_result
          until: copy_result is success
          retries: 3
          delay: 5

    - name: Verify bundle copy
      block:
        - name: Check local bundle
          ansible.builtin.stat:
            path: /tmp/rke2-bundle.tar.gz
          register: local_bundle
          failed_when: >
            not local_bundle.stat.exists or
            local_bundle.stat.size == 0 or
            local_bundle.stat.size != bastion_bundle.stat.size

        - name: Calculate local checksum
          ansible.builtin.command: sha256sum /tmp/rke2-bundle.tar.gz
          register: local_checksum
          changed_when: false

        - name: Compare checksums
          ansible.builtin.fail:
            msg: "Bundle checksums do not match. Transfer may be corrupted."
          when: bastion_checksum.stdout.split()[0] != local_checksum.stdout.split()[0]

        - name: Display bundle information
          ansible.builtin.debug:
            msg: |
              Bundle Status:
              - Source size: {{ bastion_bundle.stat.size }}
              - Local size: {{ local_bundle.stat.size }}
              - Source checksum: {{ bastion_checksum.stdout.split()[0] }}
              - Local checksum: {{ local_checksum.stdout.split()[0] }}
              - Source path: {{ bastion_bundle.stat.path }}
              - Local path: {{ local_bundle.stat.path }}
          run_once: true

- name: Extract and organize RKE2 artifacts
  block:
    - name: Create artifacts directory
      ansible.builtin.file:
        path: /tmp/rke2-artifacts
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: true

    - name: Create temp extraction directory
      ansible.builtin.file:
        path: /tmp/rke2-extract
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: true

    - name: Extract RKE2 bundle to temp directory
      ansible.builtin.unarchive:
        src: /tmp/rke2-bundle.tar.gz
        dest: /tmp/rke2-extract/
        remote_src: true
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        list_files: true
      register: extract_result
      become: true

    - name: Display extracted files
      ansible.builtin.debug:
        msg: "Extracted files: {{ extract_result.files }}"
      run_once: true

    - name: List temp directory contents
      ansible.builtin.command: ls -la /tmp/rke2-extract/
      register: temp_dir_contents
      changed_when: false

    - name: Display temp directory contents
      ansible.builtin.debug:
        msg: "Temp directory contents: {{ temp_dir_contents.stdout_lines }}"
      run_once: true

    - name: Check if artifacts already organized
      ansible.builtin.stat:
        path: /tmp/rke2-install.sh
      register: install_script_check
      become: true

    - name: Move files to correct locations
      ansible.builtin.shell: |
        set -e
        # Create required directories
        mkdir -p /tmp/rke2-artifacts

        # Move files from the extracted bundle structure
        if [ -f /tmp/rke2-extract/tmp/rke2-install.sh ]; then
          mv /tmp/rke2-extract/tmp/rke2-install.sh /tmp/rke2-install.sh
          chmod +x /tmp/rke2-install.sh
        fi

        if [ -d /tmp/rke2-extract/tmp/rke2-artifacts ]; then
          mv /tmp/rke2-extract/tmp/rke2-artifacts/* /tmp/rke2-artifacts/ 2>/dev/null || true
        fi
      register: move_result
      become: true
      changed_when: move_result.rc == 0
      when: not install_script_check.stat.exists

    - name: Display move result
      ansible.builtin.debug:
        msg: "{{ move_result.stdout_lines | default([]) | join('\n') }}"
      run_once: true

    - name: Set correct permissions
      ansible.builtin.file:
        path: /tmp/rke2-install.sh
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: true

    - name: Clean up temp directory
      ansible.builtin.file:
        path: /tmp/rke2-extract
        state: absent
      become: true

    - name: Verify RKE2 tarball exists after extraction
      ansible.builtin.stat:
        path: /tmp/rke2-artifacts/rke2.linux-amd64.tar.gz
      register: rke2_tarball_check
      failed_when: not rke2_tarball_check.stat.exists

    - name: Display RKE2 tarball status
      ansible.builtin.debug:
        msg: |
          RKE2 Tarball Status:
          - Version: {{ rke2_version }}
          - Path: /tmp/rke2-artifacts/rke2.linux-amd64.tar.gz
          - Exists: {{ rke2_tarball_check.stat.exists }}
          - Size: {{ rke2_tarball_check.stat.size | default('N/A') }} bytes
      run_once: true

    - name: Verify required files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: file_check
      failed_when: not file_check.stat.exists
      loop:
        - /tmp/rke2-artifacts/rke2.linux-amd64.tar.gz
        - /tmp/rke2-artifacts/rke2-images.tar.gz
        - /tmp/rke2-artifacts/sha256sum-amd64.txt
        - /tmp/rke2-install.sh

    - name: Display artifacts status
      ansible.builtin.debug:
        msg: |
          RKE2 Artifacts Status:
          - Bundle extracted to: /tmp/rke2-artifacts/
          - RKE2 tarball: {{ file_check.results[0].stat.exists }}
          - Images bundle: {{ file_check.results[1].stat.exists }}
          - Checksums file: {{ file_check.results[2].stat.exists }}
          - Install script: {{ file_check.results[3].stat.exists }}
      run_once: true

- name: Create RKE2 images directory
  ansible.builtin.file:
    path: /var/lib/rancher/rke2/agent/images
    state: directory
    mode: '0755'
  become: true
  when: inventory_hostname == groups[target_group][0]

- name: Copy RKE2 images to proper location
  ansible.builtin.copy:
    src: /tmp/rke2-artifacts/rke2-images.tar.gz
    dest: /var/lib/rancher/rke2/agent/images/
    remote_src: true
    mode: '0644'
  become: true
  when: inventory_hostname == groups[target_group][0]

- name: Run RKE2 server install script
  ansible.builtin.shell: |
    export INSTALL_RKE2_TYPE=server
    export INSTALL_RKE2_ARTIFACT_PATH=/tmp/rke2-artifacts
    sh /tmp/rke2-install.sh
  args:
    creates: /usr/local/lib/systemd/system/rke2-server.service
    executable: /bin/bash
  become: true
  when: inventory_hostname == groups[target_group][0]

- name: Start RKE2 server
  when: inventory_hostname == groups[target_group][0]
  block:
    - name: Start RKE2 server service
      ansible.builtin.systemd:
        name: rke2-server
        state: started
        enabled: true
      become: true
      register: rke2_start_result

    - name: Display RKE2 start success
      ansible.builtin.debug:
        msg: "RKE2 server started successfully"
      when: rke2_start_result is success
      run_once: true

  rescue:
    - name: Get RKE2 server service status
      ansible.builtin.shell: systemctl status rke2-server.service
      # Using shell because systemctl is a shell command
      register: rke2_status
      become: true
      failed_when: false
      changed_when: false

    - name: Get RKE2 server journal logs
      ansible.builtin.shell: journalctl -xeu rke2-server.service --no-pager -n 50
      # Using shell because journalctl is a shell command
      register: rke2_logs
      become: true
      failed_when: false
      changed_when: false

    - name: Display RKE2 service status and logs
      ansible.builtin.debug:
        msg: |
          RKE2 Server Service Status:
          {{ rke2_status.stdout_lines | join('\n') }}

          RKE2 Server Journal Logs:
          {{ rke2_logs.stdout_lines | join('\n') }}
      run_once: true

    - name: Check RKE2 configuration file
      ansible.builtin.shell: cat /etc/rancher/rke2/config.yaml
      # Using shell because cat is a shell command
      register: rke2_config_content
      become: true
      failed_when: false
      changed_when: false
      # Using shell because cat is a shell command

    - name: Display RKE2 configuration
      ansible.builtin.debug:
        msg: |
          RKE2 Configuration (/etc/rancher/rke2/config.yaml):
          {{ rke2_config_content.stdout_lines | join('\n') }}
      run_once: true

    - name: Fail with detailed error information
      ansible.builtin.fail:
        msg: |
          RKE2 server failed to start. Check the service status and logs above for details.
          Common issues:
          - Configuration file syntax errors
          - Missing or incorrect certificates
          - Network connectivity issues
          - Insufficient system resources
          - Container runtime issues

- name: Wait for RKE2 server to be ready
  ansible.builtin.wait_for:
    path: /var/lib/rancher/rke2/server/node-token
    timeout: 300
  become: true
  when: inventory_hostname == groups[target_group][0]

- name: Wait for RKE2 server to be fully operational
  when: inventory_hostname == groups[target_group][0]
  block:
    - name: Monitor RKE2 server startup progress
      ansible.builtin.shell: |
        echo "=== RKE2 Service Status ==="
        systemctl is-active rke2-server.service || echo "Service not active"
        echo ""
        echo "=== RKE2 Directory Structure ==="
        ls -la /var/lib/rancher/rke2/server/ 2>/dev/null || echo "Server directory not found"
        echo ""
        echo "=== Recent RKE2 Logs ==="
        journalctl -u rke2-server.service --no-pager -n 10 --since "5 minutes ago" || echo "No recent logs"
        echo ""
        echo "=== Container Runtime Status ==="
        crictl version 2>/dev/null || echo "crictl not available"
        echo ""
        echo "=== System Resources ==="
        free -h
        df -h /var/lib/rancher
      register: rke2_progress
      become: true
      changed_when: false

    - name: Display RKE2 startup progress
      ansible.builtin.debug:
        msg: "{{ rke2_progress.stdout_lines }}"
      run_once: true

    - name: Wait for RKE2 server manifests directory (extended timeout)
      ansible.builtin.wait_for:
        path: /var/lib/rancher/rke2/server/manifests
        timeout: 600
      become: true

    - name: Verify RKE2 server is fully operational
      ansible.builtin.shell: |
        echo "=== Final RKE2 Status ==="
        systemctl status rke2-server.service --no-pager -l
        echo ""
        echo "=== Manifests Directory ==="
        ls -la /var/lib/rancher/rke2/server/manifests/ 2>/dev/null || echo "Manifests directory empty"
        echo ""
        echo "=== Node Token ==="
        ls -la /var/lib/rancher/rke2/server/node-token 2>/dev/null || echo "Node token not found"
      register: rke2_final_status
      become: true
      changed_when: false

    - name: Display final RKE2 status
      ansible.builtin.debug:
        msg: "{{ rke2_final_status.stdout_lines }}"
      run_once: true

  rescue:
    - name: Get detailed RKE2 failure information
      ansible.builtin.shell: |
        echo "=== RKE2 Service Status ==="
        systemctl status rke2-server.service --no-pager -l
        echo ""
        echo "=== RKE2 Logs (last 100 lines) ==="
        journalctl -u rke2-server.service --no-pager -n 100
        echo ""
        echo "=== System Resources ==="
        free -h
        df -h
        echo ""
        echo "=== Network Status ==="
        ip addr show
        echo ""
        echo "=== RKE2 Directory Contents ==="
        find /var/lib/rancher/rke2 -type f -ls 2>/dev/null || echo "RKE2 directory not accessible"
      register: rke2_failure_info
      become: true
      failed_when: false
      changed_when: false

    - name: Display RKE2 failure information
      ansible.builtin.debug:
        msg: "{{ rke2_failure_info.stdout_lines }}"
      run_once: true

    - name: Fail with timeout information
      ansible.builtin.fail:
        msg: |
          RKE2 server failed to become fully operational within 10 minutes.
          This could indicate:
          - Slow container image pulls in airgap environment
          - Insufficient system resources (CPU/Memory/Disk)
          - Network connectivity issues
          - Container runtime problems
          - RKE2 configuration issues

          Check the detailed logs above for specific error messages.

- name: Wait for RKE2 server service
  ansible.builtin.systemd:
    name: rke2-server
    state: started
  become: true
  when: inventory_hostname == groups[target_group][0]

- name: Pause for server initialization
  ansible.builtin.pause:
    seconds: 30
  when: inventory_hostname == groups[target_group][0]

- name: Get node token from server
  ansible.builtin.slurp:
    src: /var/lib/rancher/rke2/server/node-token
  become: true
  register: node_token_result
  when: inventory_hostname == groups[target_group][0]

- name: Set node token fact on all hosts
  ansible.builtin.set_fact:
    rke2_token: "{{ hostvars[groups[target_group][0]]['node_token_result']['content'] | b64decode | trim }}"
  when: hostvars[groups[target_group][0]]['node_token_result'] is defined

- name: Configure RKE2 agent
  ansible.builtin.template:
    src: agent-config.yaml.j2
    dest: /etc/rancher/rke2/config.yaml
    mode: '0644'
  become: true
  when: inventory_hostname != groups[target_group][0]

- name: Run RKE2 agent install script
  ansible.builtin.shell: |
    export INSTALL_RKE2_TYPE=agent
    export INSTALL_RKE2_ARTIFACT_PATH=/tmp/rke2-artifacts
    sh /tmp/rke2-install.sh
  args:
    creates: /usr/local/lib/systemd/system/rke2-agent.service
    executable: /bin/bash
  become: true
  when: inventory_hostname != groups[target_group][0]

- name: Start RKE2 agent
  ansible.builtin.systemd:
    name: rke2-agent
    state: started
    enabled: true
  become: true
  when: inventory_hostname != groups[target_group][0]

- name: Wait for kubeconfig
  ansible.builtin.wait_for:
    path: /etc/rancher/rke2/rke2.yaml
  become: true
  when: inventory_hostname == groups[target_group][0]

- name: Get kubeconfig
  ansible.builtin.slurp:
    src: /etc/rancher/rke2/rke2.yaml
  become: true
  register: kubeconfig
  when: inventory_hostname == groups[target_group][0]

- name: Create local kubeconfig directory
  ansible.builtin.file:
    path: ~/.kube
    state: directory
    mode: '0755'
  delegate_to: localhost
  become: false
  when: inventory_hostname == groups[target_group][0]
  vars:
    ansible_connection: local

- name: Save kubeconfig locally
  ansible.builtin.copy:
    content: "{{ kubeconfig['content'] | b64decode }}"
    dest: ~/.kube/config
    mode: '0600'
  delegate_to: localhost
  become: false
  when: inventory_hostname == groups[target_group][0]
  vars:
    ansible_connection: local
