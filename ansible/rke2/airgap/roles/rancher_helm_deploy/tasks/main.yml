---
# Deploy Rancher to RKE2 cluster using Helm from bastion server
- name: Deploy Rancher to RKE2 cluster
  when: deploy_rancher | default(false) | bool
  tags:
    - rancher
  block:
    - name: Check if kubectl is configured on bastion
      ansible.builtin.stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_file

    - name: Fail if kubectl is not configured
      ansible.builtin.fail:
        msg: "kubectl is not configured on bastion. Run setup-kubectl-access.yml first."
      when: not kubeconfig_file.stat.exists

    - name: Check Helm installation
      ansible.builtin.command: helm version --short
      register: helm_output_version
      ignore_errors: true

    - name: Display Helm version
      when: helm_output_version.rc == 0
      ansible.builtin.debug:
        msg: "Helm version: {{ helm_output_version.stdout }}"

    - name: Install Helm if not present
      when: helm_output_version.rc != 0
      block:
        - name: Get install script
          ansible.builtin.get_url:
            url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
            dest: "/tmp/helm-{{ helm_version }}-linux-amd64.tar.gz"
            mode: "0644"
          retries: 3
          delay: 30

        - name: Extract Helm binary
          ansible.builtin.unarchive:
            src: "/tmp/helm-{{ helm_version }}-linux-amd64.tar.gz"
            dest: /tmp
            remote_src: true
            creates: /tmp/linux-amd64/helm

        - name: Install Helm binary
          become: true
          ansible.builtin.copy:
            src: /tmp/linux-amd64/helm
            dest: /usr/local/bin/helm
            mode: "0755"
            remote_src: true

        - name: Verify Helm installation
          ansible.builtin.command: helm version --short
          register: helm_version_output
          changed_when: false

        - name: Display Helm version
          ansible.builtin.debug:
            msg: "Helm version: {{ helm_version_output.stdout }}"

    - name: Add Rancher Helm repository
      kubernetes.core.helm_repository:
        name: "{{ rancher_helm_chart_repo_name }}"
        repo_url: "{{ rancher_helm_chart_repo_url }}"
      register: helm_repo_add
      until: helm_repo_add is success
      retries: 3
      delay: 10

    - name: Update Helm repositories
      ansible.builtin.command: helm repo update
      register: helm_update
      until: helm_update.rc == 0
      retries: 3
      delay: 10
      changed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Setup cert-manager
      when: rancher_tls_source == "letsEncrypt" or rancher_tls_source == "rancher"
      block:
        - name: Add jetstack Helm repository for cert-manager
          kubernetes.core.helm_repository:
            name: jetstack
            repo_url: "https://charts.jetstack.io"

        - name: Build cert-manager Helm values
          ansible.builtin.set_fact:
            cert_manager_helm_values:
              installCRDs: true

        - name: Add private registry to cert-manager values (airgap)
          when:
            - enable_private_registry | default(false) | bool
            - private_registry_mirrors is defined
          block:
            - name: Find quay.io mirror configuration
              ansible.builtin.set_fact:
                quay_mirror: "{{ private_registry_mirrors | selectattr('registry', 'equalto', 'quay.io') | first | default({}) }}"

            - name: Extract registry endpoint and rewrite prefix
              ansible.builtin.set_fact:
                cert_manager_registry: "{{ quay_mirror.endpoints[0] | default('') | regex_replace('^https?://', '') }}"
                cert_manager_rewrite_prefix: "{{ quay_mirror.rewrite[0].replacement | default('$1') | regex_replace('\\$1$', '') | regex_replace('/$', '') }}"
              when: quay_mirror | length > 0

            - name: Build cert-manager image paths
              ansible.builtin.set_fact:
                cert_manager_helm_values: "{{ cert_manager_helm_values | combine({
                  'image': {'registry': cert_manager_registry, 'repository': cert_manager_rewrite_prefix + '/jetstack/cert-manager-controller'},
                  'webhook': {'image': {'registry': cert_manager_registry, 'repository': cert_manager_rewrite_prefix + '/jetstack/cert-manager-webhook'}},
                  'cainjector': {'image': {'registry': cert_manager_registry, 'repository': cert_manager_rewrite_prefix + '/jetstack/cert-manager-cainjector'}},
                  'startupapicheck': {'image': {'registry': cert_manager_registry, 'repository': cert_manager_rewrite_prefix + '/jetstack/cert-manager-startupapicheck'}}
                }, recursive=True) }}"
              when:
                - cert_manager_registry is defined
                - cert_manager_registry | length > 0

        - name: Display cert-manager Helm values
          ansible.builtin.debug:
            msg: |
              Cert-Manager Helm Values:
              {{ cert_manager_helm_values | to_nice_yaml }}

        - name: Install cert-manager
          kubernetes.core.helm:
            name: cert-manager
            chart_ref: jetstack/cert-manager
            release_namespace: cert-manager
            create_namespace: true
            values: "{{ cert_manager_helm_values }}"
            kubeconfig: "{{ kubeconfig_path }}"

        - name: Wait for cert-manager to be ready
          kubernetes.core.k8s_info:
            api_version: apps/v1
            kind: Deployment
            name: cert-manager
            namespace: cert-manager
            kubeconfig: "{{ kubeconfig_path }}"
            wait_condition:
              type: Available
              status: "True"
            wait_timeout: 300

        - name: Wait for cert-manager pods to be Running
          kubernetes.core.k8s_info:
            api_version: v1
            kind: Pod
            namespace: cert-manager
            kubeconfig: "{{ kubeconfig_path }}"
          register: cert_manager_pods
          until: cert_manager_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length >= 3
          retries: 12
          delay: 10

    - name: Build Rancher Helm values
      ansible.builtin.set_fact:
        rancher_helm_values:
          hostname: "{{ rancher_private_hostname }}"
          bootstrapPassword: "{{ rancher_bootstrap_password }}"
          useBundledSystemChart: "{{ rancher_use_bundled_system_charts }}"
          ingress:
            tls:
              source: "{{ rancher_tls_source }}"

    - name: Configure Rancher for private registry (airgap)
      when:
        - enable_private_registry | default(false) | bool
        - private_registry_mirrors is defined
      block:
        - name: Find docker.io mirror configuration for Rancher
          ansible.builtin.set_fact:
            docker_mirror: "{{ private_registry_mirrors | selectattr('registry', 'equalto', 'docker.io') | first | default({}) }}"

        - name: Extract docker.io registry endpoint and rewrite prefix
          ansible.builtin.set_fact:
            rancher_registry: "{{ docker_mirror.endpoints[0] | default('') | regex_replace('^https?://', '') }}"
            rancher_rewrite_prefix: "{{ docker_mirror.rewrite[0].replacement | default('$1') | regex_replace('\\$1$', '') | regex_replace('/$', '') }}"
          when: docker_mirror | length > 0

        - name: Build systemDefaultRegistry with rewrite prefix
          ansible.builtin.set_fact:
            rancher_helm_values: "{{ rancher_helm_values | combine({'systemDefaultRegistry': rancher_registry + '/' + rancher_rewrite_prefix}) }}"
          when:
            - rancher_registry is defined
            - rancher_registry | length > 0
            - rancher_rewrite_prefix is defined
            - rancher_rewrite_prefix | length > 0

    - name: Add rancherImageTag to Helm values
      ansible.builtin.set_fact:
        rancher_helm_values: "{{ rancher_helm_values | combine({'rancherImageTag': rancher_image_tag}) }}"
      when: rancher_image_tag is defined and rancher_image_tag | length > 0

    - name: Display Rancher Helm values
      ansible.builtin.debug:
        msg: |
          Rancher Helm Values:
          {{ rancher_helm_values | to_nice_yaml }}

    - name: Install or Upgrade Rancher using Helm
      kubernetes.core.helm:
        name: rancher
        chart_ref: "{{ rancher_helm_chart_repo_name }}/rancher"
        chart_version: "{{ rancher_chart_version | default('') }}"
        release_namespace: "{{ rancher_namespace }}"
        create_namespace: true
        wait: true
        wait_timeout: 600s
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        values: "{{ rancher_helm_values }}"

    - name: Wait for Rancher deployment to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: rancher
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 600

    - name: Get Rancher service information
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: rancher
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"

    - name: Display Rancher deployment status
      ansible.builtin.debug:
        msg: |
          Rancher has been successfully deployed!
          Namespace: {{ rancher_namespace }}
          Hostname: {{ rancher_private_hostname }}
          Access URL: https://{{ rancher_private_hostname }}
