---
# Deploy Rancher to RKE2 cluster using Helm from bastion server
- name: Deploy Rancher to RKE2 cluster
  when: deploy_rancher | default(false) | bool
  tags:
    - rancher
  block:
    - name: Check if kubectl is configured on bastion
      ansible.builtin.stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_file

    - name: Fail if kubectl is not configured
      ansible.builtin.fail:
        msg: "kubectl is not configured on bastion. Run setup-kubectl-access.yml first."
      when: not kubeconfig_file.stat.exists

    - name: Check Helm installation
      ansible.builtin.command: helm version --short
      register: helm_output_version
      ignore_errors: true

    - name: Display Helm version
      when: helm_output_version.rc == 0
      ansible.builtin.debug:
        msg: "Helm version: {{ helm_output_version.stdout }}"

    - name: Install Helm if not present
      when: helm_output_version.rc != 0
      block:
        - name: Get install script
          ansible.builtin.get_url:
            url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
            dest: "/tmp/helm-{{ helm_version }}-linux-amd64.tar.gz"
            mode: "0644"
          retries: 3
          delay: 30

        - name: Extract Helm binary
          ansible.builtin.unarchive:
            src: "/tmp/helm-{{ helm_version }}-linux-amd64.tar.gz"
            dest: /tmp
            remote_src: true
            creates: /tmp/linux-amd64/helm

        - name: Install Helm binary
          become: true
          ansible.builtin.copy:
            src: /tmp/linux-amd64/helm
            dest: /usr/local/bin/helm
            mode: "0755"
            remote_src: true

        - name: Verify Helm installation
          ansible.builtin.command: helm version --short
          register: helm_version_output
          changed_when: false

        - name: Display Helm version
          ansible.builtin.debug:
            msg: "Helm version: {{ helm_version_output.stdout }}"

    - name: Add Rancher Helm repository
      kubernetes.core.helm_repository:
        name: "{{ rancher_helm_chart_repo_name }}"
        repo_url: "{{ rancher_helm_chart_repo_url }}"
      register: helm_repo_add
      until: helm_repo_add is success
      retries: 3
      delay: 10

    - name: Update Helm repositories
      ansible.builtin.command: helm repo update
      register: helm_update
      until: helm_update.rc == 0
      retries: 3
      delay: 10
      changed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Setup cert-manager
      when: rancher_tls_source == "letsEncrypt" or rancher_tls_source == "rancher"
      block:
        - name: Add jetstack Helm repository for cert-manager
          kubernetes.core.helm_repository:
            name: jetstack
            repo_url: "https://charts.jetstack.io"

        - name: Install cert-manager
          kubernetes.core.helm:
            name: cert-manager
            chart_ref: jetstack/cert-manager
            release_namespace: cert-manager
            create_namespace: true
            values:
              installCRDs: true
            kubeconfig: "{{ kubeconfig_path }}"

        - name: Wait for cert-manager to be ready
          kubernetes.core.k8s_info:
            api_version: apps/v1
            kind: Deployment
            name: cert-manager
            namespace: cert-manager
            kubeconfig: "{{ kubeconfig_path }}"
            wait_condition:
              type: Available
              status: "True"
            wait_timeout: 300

        - name: Wait for cert-manager pods to be Running
          kubernetes.core.k8s_info:
            api_version: v1
            kind: Pod
            namespace: cert-manager
            kubeconfig: "{{ kubeconfig_path }}"
          register: cert_manager_pods
          until: cert_manager_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length >= 3
          retries: 12
          delay: 10

    - name: Install or Upgrade Rancher using Helm
      kubernetes.core.helm:
        name: rancher
        chart_ref: "{{ rancher_helm_chart_repo_name }}/rancher"
        chart_version: "{{ rancher_chart_version | default('') }}"
        release_namespace: "{{ rancher_namespace }}"
        create_namespace: true
        wait: true
        wait_timeout: 600s
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          hostname: "{{ rancher_private_hostname }}"
          bootstrapPassword: "{{ rancher_bootstrap_password }}"
          useBundledSystemChart: "{{ rancher_use_bundled_system_charts }}"
          ingress:
            tls:
              source: "{{ rancher_tls_source }}"

    - name: Wait for Rancher deployment to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: rancher
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 600

    - name: Get Rancher service information
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: rancher
        namespace: "{{ rancher_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"

    - name: Display Rancher deployment status
      ansible.builtin.debug:
        msg: |
          Rancher has been successfully deployed!
          Namespace: {{ rancher_namespace }}
          Hostname: {{ rancher_private_hostname }}
          Access URL: https://{{ rancher_private_hostname }}
