# K3s Configuration

# Only servers/cluster-init should set write-kubeconfig-mode (agent doesn't accept it)
{% if k3s_node_type in ['cluster-init', 'server'] %}
write-kubeconfig-mode: "0644"
{% endif %}

# Node labels and taints based on role combinations (matching RKE2 logic)
{% set has_etcd = 'etcd' in (ansible_role | default('')) %}
{% set has_cp = 'cp' in (ansible_role | default('')) %}
{% set has_worker = 'worker' in (ansible_role | default('')) %}

{% if not has_etcd and has_cp and not has_worker %}
# Control plane only node
node-taint:
  - node-role.kubernetes.io/control-plane:NoSchedule
node-label:
  - role-control-plane=true
{% elif not has_etcd and has_cp and has_worker %}
# Control plane + worker node
node-label:
  - role-control-plane=true
  - role-worker=true
{% elif has_etcd and has_cp and not has_worker %}
# ETCD + control plane node
node-taint:
  - node-role.kubernetes.io/control-plane:NoSchedule
  - node-role.kubernetes.io/etcd:NoExecute
node-label:
  - role-etcd=true
  - role-control-plane=true
{% elif has_etcd and has_worker and not has_cp %}
# ETCD + worker node
node-label:
  - role-etcd=true
  - role-worker=true
{% elif has_etcd and not has_cp and not has_worker %}
# ETCD only node
node-taint:
  - node-role.kubernetes.io/etcd:NoExecute
node-label:
  - role-etcd=true
{% elif k3s_node_type == 'agent' %}
# Worker-only node
node-label:
  - role-worker=true
{% else %}
# Default: all roles
node-label:
  - role-etcd=true
  - role-control-plane=true
  - role-worker=true
{% endif %}

# Node type specific configuration
{% if k3s_node_type == 'cluster-init' %}
cluster-init: true
{% elif k3s_node_type == 'server' and (kube_api_host | default(k3s_api_host) | default('')) != '' %}
server: "https://{{ kube_api_host | default(k3s_api_host) }}:6443"
{% if k3s_token | default('') | trim %}
token: "{{ k3s_token }}"
{% endif %}
{% elif k3s_node_type == 'agent' and (kube_api_host | default(k3s_api_host) | default('')) != '' %}
server: "https://{{ kube_api_host | default(k3s_api_host) }}:6443"
{% if k3s_token | default('') | trim %}
token: "{{ k3s_token }}"
{% endif %}
{% endif %}

# Advertise public/external IP to the cluster (used by kubelet/kube-proxy)
{% if public_ip is defined and public_ip | trim != '' %}
node-external-ip:
  - "{{ public_ip }}"
{% endif %}

# TLS SAN entries for comprehensive certificate validity (servers only)
{% if k3s_node_type in ['cluster-init', 'server'] %}
tls-san:
  - "{{ fqdn | default(k3s_fqdn) | default('localhost') }}"
  - "{{ kube_api_host | default(k3s_api_host) | default('127.0.0.1') }}"
  - "{{ public_ip | default('127.0.0.1') }}"
  - "{{ ansible_host | default('127.0.0.1') }}"
  - "{{ inventory_hostname }}"
  - "localhost"
  - "127.0.0.1"
{% endif %}

# Server flags (render only if provided and node is server/cluster-init)
{% if k3s_node_type in ['cluster-init', 'server'] %}
{% if server_flags is defined and server_flags | trim %}
{{ server_flags }}
{% elif role_server_flags is defined and role_server_flags | trim %}
{{ role_server_flags }}
{% endif %}
{% endif %}

# Worker flags (render only if provided and node is agent)
{% if k3s_node_type == 'agent' %}
{% if worker_flags is defined and worker_flags | trim %}
{{ worker_flags }}
{% elif role_worker_flags is defined and role_worker_flags | trim %}
{{ role_worker_flags }}
{% endif %}
{% endif %}

# CIS hardening configuration
{% set is_hardening_enabled = (server_flags is defined and 'protect-kernel-defaults' in server_flags) or (role_server_flags is defined and 'protect-kernel-defaults' in role_server_flags) %}
{% if is_hardening_enabled and k3s_node_type in ['cluster-init', 'server'] %}
secrets-encryption: true
kube-apiserver-arg:
  - "enable-admission-plugins=NodeRestriction,EventRateLimit,PodSecurity"
  - "admission-control-config-file=/var/lib/rancher/k3s/server/admission-config.yaml"
  - "audit-log-path=/var/lib/rancher/k3s/server/logs/audit.log"
  - "audit-policy-file=/var/lib/rancher/k3s/server/audit.yaml"
  - "audit-log-maxage=30"
  - "audit-log-maxbackup=10"
  - "audit-log-maxsize=100"
  - "service-account-extend-token-expiration=false"

kube-controller-manager-arg:
  - "terminated-pod-gc-threshold=100"

kubelet-arg:
  - "streaming-connection-idle-timeout=5m"
  - "tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"

{% elif k3s_node_type == 'agent' %}
# Agent kubelet configuration
kubelet-arg:
  - "streaming-connection-idle-timeout=5m"
  - "make-iptables-util-chains=true"
  - "tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
{% endif %}